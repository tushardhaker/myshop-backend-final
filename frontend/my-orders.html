<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders | MyShop.pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        :root { 
            --primary: #1a222d; 
            --accent: #febd69; 
            --bg-gray: #f0f2f2; 
            --success: #2e7d32;
            --text-dark: #111;
        }

        body { background-color: var(--bg-gray); font-family: 'Inter', sans-serif; color: var(--text-dark); }
        
        /* --- IMPROVED HEADER (NAVBAR) --- */
        .navbar { 
            background: linear-gradient(90deg, #1a222d 0%, #232f3e 100%); 
            padding: 15px 0; 
            border-bottom: 4px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .navbar-brand { 
            font-size: 24px; 
            font-weight: 800; 
            letter-spacing: -0.5px;
            color: white !important;
        }
        .nav-link-custom {
            color: #eee;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            padding: 8px 15px;
            border-radius: 6px;
            transition: 0.3s;
        }
        .nav-link-custom:hover {
            background: rgba(255,255,255,0.1);
            color: var(--accent);
        }

        /* --- SEARCH BOX --- */
        .search-container { position: relative; }
        .search-container i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888; }
        .search-input { 
            padding-left: 42px; 
            border-radius: 50px; 
            border: 1px solid #ccc; 
            height: 45px; 
            width: 380px !important; 
            font-size: 14px;
            transition: 0.3s;
        }
        .search-input:focus { border-color: var(--accent); box-shadow: 0 0 8px rgba(254, 189, 105, 0.4); }

        /* --- IMPROVED BUTTONS --- */
        .btn-action { 
            padding: 8px 18px; 
            border-radius: 50px; /* Pill shape */
            font-size: 13px; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            border: 1px solid #d5d9d9; 
            background: white; 
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }

        .btn-chat { 
            background: #f0f8ff; 
            border-color: #007185; 
            color: #007185; 
        }
        .btn-chat:hover { background: #007185; color: white; }

        .btn-cancel { 
            border-color: #d32f2f; 
            color: #d32f2f; 
        }
        .btn-cancel:hover { background: #d32f2f; color: white; }

        .btn-rate { 
            background: var(--accent); 
            border-color: #a88734; 
            color: #111;
        }
        .btn-rate:hover { background: #f3a847; }

        /* Order Card & Tracking (Keeping your original logic) */
        .order-card { 
            background: white; border-radius: 12px; border: 1px solid #d5d9d9; 
            margin-bottom: 30px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.06);
        }
        .order-header { background-color: #f6f6f6; padding: 18px 25px; border-bottom: 1px solid #d5d9d9; display: flex; justify-content: space-between; align-items: center; }
        .header-meta { display: flex; gap: 40px; }
        .meta-label { font-size: 11px; text-transform: uppercase; color: #565959; display: block; margin-bottom: 2px; }
        .meta-value { font-size: 14px; font-weight: 600; color: #333; }
        .order-body { padding: 25px; }
        .product-title { font-size: 16px; font-weight: 700; color: #007185; text-decoration: none; }
        .shop-tag { background: #f0f2f2; color: #565959; font-size: 12px; padding: 4px 12px; border-radius: 20px; border: 1px solid #ddd; }
        .tracking-box { background: #fafafa; border-radius: 8px; padding: 20px; border: 1px solid #eee; margin-top: 15px; }
        .track-wrapper { position: relative; display: flex; justify-content: space-between; margin-top: 10px; }
        .track-line-bg { position: absolute; top: 12px; left: 10%; width: 80%; height: 6px; background: #e0e0e0; z-index: 1; border-radius: 10px; }
        .track-line-active { position: absolute; top: 12px; left: 10%; height: 6px; background: var(--success); z-index: 2; transition: width 1s ease; border-radius: 10px; }
        .track-point { position: relative; z-index: 3; text-align: center; width: 60px; }
        .dot { width: 30px; height: 30px; background: white; border: 3px solid #e0e0e0; border-radius: 50%; margin: 0 auto 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #999; }
        .track-point.active .dot { border-color: var(--success); color: var(--success); background: #e8f5e9; }
        .track-point.completed .dot { background: var(--success); border-color: var(--success); color: white; }
        .track-point span { font-size: 11px; font-weight: 700; color: #666; }
        .track-point small { font-size: 9px; display: block; color: var(--success); font-weight: 600; }
        #chatWindow { height: 400px; background: #fff; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .msg { margin-bottom: 10px; padding: 10px 15px; border-radius: 12px; max-width: 85%; font-size: 14px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-sent { background: #dcf8c6; margin-left: auto; border-bottom-right-radius: 2px; }
        .msg-received { background: white; margin-right: auto; border-bottom-left-radius: 2px; }
        .star-rating i { font-size: 28px; color: #ddd; cursor: pointer; transition: 0.2s; }
        .star-rating i.checked { color: #ffa41c; transform: scale(1.1); }
    </style>
</head>
<body>

    <nav class="navbar shadow-sm mb-5">
        <div class="container d-flex justify-content-between align-items-center px-4">
            <div class="d-flex align-items-center gap-4">
                <a class="navbar-brand" href="customer.html">MyShop<span class="text-warning">.pro</span></a>
                <a href="customer.html" class="nav-link-custom"><i class="fas fa-arrow-left me-1"></i> Back to Shop</a>
            </div>
            <div class="text-white d-flex align-items-center gap-3">
                <div class="border-start ps-3 ms-2">
                    <span class="small opacity-75">Hello,</span>
                    <div class="fw-bold" id="userNameDisplay">Account</div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row align-items-center mb-4">
            <div class="col-md-6">
                <h2 class="page-title">Your Orders</h2>
            </div>
            <div class="col-md-6 text-end">
                <div class="search-container d-inline-block">
                    <i class="fas fa-search"></i>
                    <input type="text" id="orderSearch" class="form-control search-input shadow-none" placeholder="Search orders or products..." onkeyup="filterOrders()">
                </div>
            </div>
        </div>
        
        <div id="ordersList">
            <div class="text-center py-5">
                <div class="spinner-grow text-warning"></div>
                <p class="mt-3 text-muted fw-bold">Syncing your order history...</p>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reviewModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0" style="border-radius: 15px;">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">How's your product?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="star-rating mb-4" id="starContainer">
                        <i class="fas fa-star" onclick="setRating(1)"></i>
                        <i class="fas fa-star" onclick="setRating(2)"></i>
                        <i class="fas fa-star" onclick="setRating(3)"></i>
                        <i class="fas fa-star" onclick="setRating(4)"></i>
                        <i class="fas fa-star" onclick="setRating(5)"></i>
                    </div>
                    <textarea id="reviewComment" class="form-control" rows="4" placeholder="Write a few words about the quality..."></textarea>
                    <input type="hidden" id="targetItemId">
                </div>
                <div class="modal-footer border-0 p-3">
                    <button type="button" class="btn btn-warning w-100 fw-bold py-2 rounded-pill" onclick="submitReview()">Submit Review</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content overflow-hidden border-0 shadow-lg" style="border-radius: 15px;">
                <div class="modal-header bg-primary text-white border-0">
                    <h6 class="modal-title" id="chatTitle">Chat</h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="chatWindow" class="p-3 overflow-auto"></div>
                    <div class="p-3 bg-light border-top">
                        <div class="input-group">
                            <input type="file" id="chatImageInput" style="display:none" onchange="uploadAndSendImage(this)">
                            <button class="btn btn-light border" onclick="document.getElementById('chatImageInput').click()"><i class="fas fa-camera"></i></button>
                            <input type="text" id="chatInput" class="form-control" placeholder="Type message...">
                            <button class="btn btn-warning fw-bold" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const BASE_URL = "https://myshop-backend-final-1.onrender.com/api";
    const userId = localStorage.getItem('userId');
    const userName = localStorage.getItem('userName');
    let allOrders = [];
    let activeChatShopId = null;

    document.addEventListener('DOMContentLoaded', () => {
        if (!userId) { window.location.href = 'login.html'; return; }
        document.getElementById('userNameDisplay').innerText = userName || "My Account";
        fetchOrders();
    });

    async function fetchOrders() {
        try {
            const response = await fetch(`${BASE_URL}/orders/user/${userId}`);
            allOrders = await response.json();
            renderOrders(allOrders.slice().reverse());
        } catch (err) {
            document.getElementById('ordersList').innerHTML = `<div class="text-center py-5"><p>Error loading orders.</p></div>`;
        }
    }

    function renderOrders(orders) {
        const listContainer = document.getElementById('ordersList');
        if (orders.length === 0) {
            listContainer.innerHTML = `<div class="text-center py-5"><h4>No orders yet!</h4></div>`;
            return;
        }

        listContainer.innerHTML = orders.map(order => {
            const dateStr = new Date(order.orderDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
            return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="header-meta">
                            <div><span class="meta-label">Order Placed</span><span class="meta-value">${dateStr}</span></div>
                            <div><span class="meta-label">Total</span><span class="meta-value">₹${order.totalAmount.toLocaleString()}</span></div>
                        </div>
                        <div class="text-end">
                            <span class="meta-label">Order # MS-${order.id}</span>
                        </div>
                    </div>
                    <div class="order-body">
                        <div class="row">
                            <div class="col-md-7">
                                ${order.items.map(item => `
                                    <div class="d-flex mb-4 pb-3 border-bottom align-items-start">
                                        <div class="me-3 bg-light rounded d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                            <i class="fas fa-shopping-bag text-muted fa-2x"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <a href="#" class="product-title">${item.productName}</a>
                                            <div class="mt-1"><span class="shop-tag"><i class="fas fa-store me-1"></i>${item.shopName}</span></div>
                                            <div class="mt-3 d-flex gap-2">
                                                <button onclick="openChat(${item.shopId}, '${item.shopName}')" class="btn btn-action btn-chat">Chat Seller</button>
                                                ${item.itemStatus === 'PLACED' ? `<button onclick="cancelOrderItem(${item.id})" class="btn btn-action btn-cancel">Cancel Item</button>` : ''}
                                                ${item.itemStatus === 'DELIVERED' ? `<button onclick="openReviewModal(${item.id})" class="btn btn-action btn-rate">Rate Item</button>` : ''}
                                            </div>
                                            ${item.rating ? `<div class="mt-3 p-2 bg-light rounded small text-muted"><div class="text-warning">${'★'.repeat(item.rating)}${'☆'.repeat(5-item.rating)}</div>"${item.review}"</div>` : ''}
                                        </div>
                                        <div class="text-end ps-3">
                                            <div class="fw-bold">₹${item.price.toLocaleString()}</div>
                                            <div class="small text-muted">Qty: ${item.quantity}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="col-md-5 border-start">
                                <div class="px-3">
                                    <h6 class="fw-bold small mb-4">Delivery Progress</h6>
                                    ${renderTimeline(order.items[0])}
                                    <div class="mt-4 p-3 rounded bg-light border small">
                                        <strong>Address:</strong><br>${order.address}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    function renderTimeline(item) {
        const fillWidth = item.itemStatus === 'DELIVERED' ? '100%' : (item.itemStatus === 'SHIPPED' ? '50%' : '0%');
        return `<div class="tracking-box"><div class="track-wrapper">
            <div class="track-line-bg"></div><div class="track-line-active" style="width: ${fillWidth};"></div>
            <div class="track-point completed"><div class="dot"><i class="fas fa-check"></i></div><span>Placed</span></div>
            <div class="track-point ${item.shippedAt ? 'completed' : 'active'}"><div class="dot"><i class="fas fa-truck"></i></div><span>Shipped</span></div>
            <div class="track-point ${item.deliveredAt ? 'completed' : ''}"><div class="dot"><i class="fas fa-home"></i></div><span>Delivered</span></div>
        </div></div>`;
    }

    async function openChat(shopId, shopName) {
        activeChatShopId = shopId;
        document.getElementById('chatTitle').innerText = shopName;
        new bootstrap.Modal(document.getElementById('chatModal')).show();
        loadChatHistory();
    }

    async function loadChatHistory() {
        if(!activeChatShopId) return;
        const res = await fetch(`${BASE_URL}/chat/history/${userId}/${activeChatShopId}`);
        const history = await res.json();
        const win = document.getElementById('chatWindow');
        win.innerHTML = history.map(m => `<div class="msg ${m.senderType === 'CUSTOMER' ? 'msg-sent' : 'msg-received'}">${m.message}</div>`).join('');
        win.scrollTop = win.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('chatInput');
        if(!input.value.trim()) return;
        await fetch(`${BASE_URL}/chat/send`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ senderId: userId, receiverId: activeChatShopId, senderType: 'CUSTOMER', message: input.value })
        });
        input.value = ''; loadChatHistory();
    }

    let selectedRating = 0;
    function openReviewModal(itemId) { 
        document.getElementById('targetItemId').value = itemId; 
        new bootstrap.Modal(document.getElementById('reviewModal')).show(); 
    }
    function setRating(n) { 
        selectedRating = n; 
        document.querySelectorAll('#starContainer i').forEach((s, i) => i < n ? s.classList.add('checked') : s.classList.remove('checked')); 
    }
    async function submitReview() {
        const itemId = document.getElementById('targetItemId').value;
        await fetch(`${BASE_URL}/orders/item/${itemId}/review`, {
            method: 'PUT', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ rating: selectedRating, review: document.getElementById('reviewComment').value })
        });
        location.reload();
    }

    function filterOrders() {
        const term = document.getElementById('orderSearch').value.toLowerCase();
        const filtered = allOrders.filter(o => o.items.some(i => i.productName.toLowerCase().includes(term)));
        renderOrders(filtered);
    }

    async function cancelOrderItem(id) { 
        if(confirm("Cancel this item?")) { 
            await fetch(`${BASE_URL}/orders/item/${id}/status?status=CANCELLED`, {method:'PUT'}); 
            fetchOrders(); 
        } 
    }
</script>
</body>
</html>