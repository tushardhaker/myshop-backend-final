<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management | Shopkeeper Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .navbar { background: #0f172a; padding: 1rem; }
        .inventory-card {
            background: white; border-radius: 12px; border: none;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .table thead { background: #f1f5f9; }
        .product-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .low-stock { color: #ef4444; font-weight: 700; background: #fee2e2; padding: 2px 8px; border-radius: 5px; }
        .in-stock { color: #10b981; font-weight: 700; background: #dcfce7; padding: 2px 8px; border-radius: 5px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="dashboard.html">
                <i class="fas fa-arrow-left me-2"></i> Dashboard
            </a>
            <span class="text-white small">Inventory Control</span>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold m-0">My Inventory</h3>
            <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus me-2"></i> Add New Product
            </button>
        </div>

        <div class="inventory-card p-3">
            <div class="table-responsive">
                <table class="table align-middle">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock Qty</th>
                            <th>Status</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryList">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title fw-bold">Add New Product</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="productForm">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Product Name</label>
                            <input type="text" id="pName" class="form-control" placeholder="e.g. Fresh Curd" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold">Category</label>
                                <select id="pCategory" class="form-select">
                                    <option value="Dairy">Dairy</option>
                                    <option value="Bakery">Bakery</option>
                                    <option value="Groceries">Groceries</option>
                                    <option value="Drinks">Drinks</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">Price (₹)</label>
                                <input type="number" id="pPrice" class="form-control" placeholder="50" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Initial Stock Quantity</label>
                            <input type="number" id="pStock" class="form-control" placeholder="100" required>
                        </div>
                        <button type="submit" class="btn btn-dark w-100 py-2 fw-bold">Save Product</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const shopId = localStorage.getItem('shopId');

        document.addEventListener('DOMContentLoaded', () => {
            if (!shopId) {
                window.location.href = 'login.html';
                return;
            }
            fetchInventory();
        });

        // Load Products
        async function fetchInventory() {
            try {
                const response = await fetch(`https://myshop-backend-final-1.onrender.com/api/products/shop/${shopId}`);
                const products = await response.json();
                renderInventory(products);
            } catch (err) {
                console.error("Fetch Error:", err);
            }
        }

        function renderInventory(products) {
            const list = document.getElementById('inventoryList');
            if (products.length === 0) {
                list.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">No products in inventory.</td></tr>`;
                return;
            }

            list.innerHTML = products.map(p => {
                const isLow = p.stock < 10;
                return `
                    <tr>
                        <td>
                            <div class="fw-bold text-dark">${p.name}</div>
                            <small class="text-muted">ID: #PROD-${p.id}</small>
                        </td>
                        <td>${p.category || 'General'}</td>
                        <td class="fw-bold">₹${p.price}</td>
                        <td>${p.stock}</td>
                        <td>
                            <span class="${isLow ? 'low-stock' : 'in-stock'}">
                                ${isLow ? 'Low Stock' : 'Available'}
                            </span>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="updateStock(${p.id}, 10)">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${p.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Add Product Form Submit
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const productData = {
                name: document.getElementById('pName').value,
                category: document.getElementById('pCategory').value,
                price: parseFloat(document.getElementById('pPrice').value),
                stock: parseInt(document.getElementById('pStock').value),
                shopId: parseInt(shopId)
            };

            try {
                const response = await fetch(`https://myshop-backend-final-1.onrender.com/api/products/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    alert("Product added successfully!");
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    document.getElementById('productForm').reset();
                    fetchInventory();
                }
            } catch (err) {
                alert("Error adding product");
            }
        });

        // Placeholder for Delete (Aapko apna backend endpoint use karna hoga)
        async function deleteProduct(id) {
            if(confirm("Are you sure you want to delete this product?")) {
                try {
                    await fetch(`https://myshop-backend-final-1.onrender.com/api/products/delete/${id}`, { method: 'DELETE' });
                    fetchInventory();
                } catch (err) { console.error(err); }
            }
        }

        // Quick Stock Update
        async function updateStock(id, amount) {
            try {
                await fetch(`https://myshop-backend-final-1.onrender.com/api/products/update-stock/${id}?amount=${amount}`, { method: 'PUT' });
                fetchInventory();
            } catch (err) { console.error(err); }
        }
    </script>
</body>
</html>