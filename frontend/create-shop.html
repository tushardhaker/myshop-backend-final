<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Your Shop | MyShop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #0f1111; color: white; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .setup-card { background: #1a1c1e; padding: 40px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); width: 100%; max-width: 450px; border: 1px solid #333; }
        .btn-primary { background: #ff9900; border: none; padding: 12px; border-radius: 12px; font-weight: 600; color: black; }
        .btn-primary:hover { background: #e68a00; }
        .form-control { background: #2a2d31; border: 1px solid #4d4d4d; color: white; }
        .form-control:focus { background: #313439; color: white; border-color: #ff9900; box-shadow: none; }
    </style>
</head>
<body>

    <div class="setup-card">
        <div class="text-center mb-4">
            <h2 class="fw-bold" style="color: #ff9900;">Setup Your Shop üè™</h2>
            <p class="text-muted">Fill in the details to start selling.</p>
        </div>

        <form id="createShopForm">
            <div class="mb-3">
                <label class="form-label fw-bold small text-uppercase">Shop Name</label>
                <input type="text" id="shopName" class="form-control" placeholder="Enter shop name" required>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold small text-uppercase">Contact Number</label>
                <input type="text" id="shopContact" class="form-control" placeholder="+91..." required>
            </div>
            <div class="mb-4">
                <label class="form-label fw-bold small text-uppercase">Shop Location</label>
                <textarea id="shopAddress" class="form-control" rows="3" placeholder="Full address..." required></textarea>
            </div>
            <button type="submit" id="submitBtn" class="btn btn-primary w-100">Create Shop & Go to Dashboard</button>
        </form>
    </div>

    <script>
        // --- 1. URL se userId nikalna ---
        const urlParams = new URLSearchParams(window.location.search);
        let userId = urlParams.get('userId') || urlParams.get('id'); 
        
        // Agar URL mein nahi hai toh localStorage try karein
        if (!userId) {
            userId = localStorage.getItem('userId');
        }

        console.log("Current User ID for Shop Creation:", userId);

        document.getElementById('createShopForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userId) {
                alert("User session expired. Please login again.");
                window.location.href = 'login.html';
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = "Creating Shop...";

            const shopData = {
                name: document.getElementById('shopName').value,
                contact: document.getElementById('shopContact').value,
                address: document.getElementById('shopAddress').value,
                ownerId: parseInt(userId) // Linking shop to the correct user
            };

            try {
                const response = await fetch('http://localhost:8080/api/shops/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(shopData)
                });

                if (response.ok) {
                    const shop = await response.json();
                    
                    // Dashboard par jane se pehle details save karein
                    localStorage.setItem('shopId', shop.id);
                    localStorage.setItem('userId', userId);
                    localStorage.setItem('role', 'SHOPKEEPER');

                    alert("Congratulations! Your shop is ready.");
                    
                    // Redirect path ko handle karein (Aapke dashboard file ka naam)
                    window.location.href = `shopkeeper_dashboard.html?id=${userId}&shopId=${shop.id}`;
                } else {
                    const errorMsg = await response.text();
                    alert("Error creating shop: " + errorMsg);
                }
            } catch (err) {
                console.error(err);
                alert("Server error! Make sure Backend is running.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Create Shop & Go to Dashboard";
            }
        });
    </script>
</body>
</html>